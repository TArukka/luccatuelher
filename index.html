<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucca Tuelher | Portfolio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,300&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           DESIGN SYSTEM
           ======================================== */
        :root {
            --bg:        #F2EFE8;   /* Papel creme envelhecido */
            --bg2:       #E8E4DB;   /* Creme mais escuro */
            --ink:       #1C1B18;   /* Quase preto */
            --ink-soft:  #5A574F;   /* Cinza quente */
            --ink-pale:  #A09C93;   /* Cinza p√°lido */
            --rule:      #C8C4BB;   /* Linha de r√©gua */
            --accent:    #C1440E;   /* Vermelho tijolo */
            --accent2:   #2D5A8E;   /* Azul cobalto */
            --white:     #FAFAF7;
            
            --serif:  'DM Serif Display', Georgia, serif;
            --sans:   'DM Sans', Helvetica, sans-serif;
            --mono:   'DM Mono', 'Courier New', monospace;
            
            --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
            --ease-out: cubic-bezier(0.0, 0.0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }

        body {
            background: var(--bg);
            color: var(--ink);
            font-family: var(--sans);
            font-weight: 300;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        /* Bil√≠ngue */
        body.lang-pt .en-only { display: none !important; }
        body.lang-en .pt-only { display: none !important; }
        .hidden { display: none !important; }

        /* ========================================
           GRAIN TEXTURE OVERLAY
           ======================================== */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 9000;
            pointer-events: none;
            opacity: 0.018;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 256px 256px;
        }

        /* ========================================
           LAYOUT
           ======================================== */
        .container {
            width: min(70%, 1100px);
            min-width: 320px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* ========================================
           HEADER
           ======================================== */
        header {
            padding: 2.5rem 0 2rem;
            border-bottom: 1.5px solid var(--ink);
            margin-bottom: 0;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: end;
            gap: 20px;
        }

        .header-identity { }

        .header-name {
            font-family: var(--serif);
            font-size: clamp(2rem, 5vw, 3.2rem);
            font-weight: 400;
            letter-spacing: -0.02em;
            line-height: 1;
            color: var(--ink);
        }

        .header-role {
            font-family: var(--sans);
            font-size: 0.78rem;
            font-weight: 400;
            color: var(--ink-soft);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-top: 6px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        /* Lang flags */
        .lang-icons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .flag-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.3;
            transition: opacity 0.2s;
            padding: 2px;
        }
        .flag-btn:hover { opacity: 0.7; }
        body.lang-pt .flag-btn[data-lang="pt"] { opacity: 1; }
        body.lang-en .flag-btn[data-lang="en"] { opacity: 1; }

        /* Nav */
        nav {
            display: flex;
            gap: 0;
            align-items: center;
        }

        .nav-link {
            font-family: var(--mono);
            font-size: 0.72rem;
            font-weight: 500;
            color: var(--ink-soft);
            text-decoration: none;
            cursor: pointer;
            padding: 6px 14px;
            border: 1px solid transparent;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: all 0.2s var(--ease);
            user-select: none;
            white-space: nowrap;
        }

        .nav-link:hover {
            color: var(--ink);
            border-color: var(--rule);
        }

        .nav-link.active {
            color: var(--ink);
            border-color: var(--ink);
        }

        .nav-link.private-btn {
            color: var(--accent);
        }

        .nav-link.private-btn:hover {
            border-color: var(--accent);
        }

        /* ========================================
           ISSUE BAR (como uma publica√ß√£o de revista)
           ======================================== */
        .issue-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--rule);
            margin-bottom: 70px;
        }

        .issue-text {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* ========================================
           SECTION TITLES
           ======================================== */
        .section-title {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 20px;
            margin: 80px 0 50px;
        }

        .section-label {
            font-family: var(--mono);
            font-size: 0.68rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--ink-soft);
            white-space: nowrap;
        }

        .section-rule {
            height: 1px;
            background: var(--rule);
        }

        .section-num {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--ink-pale);
        }

        /* ========================================
           BANNER
           ======================================== */
        .banner-container {
            width: 100%;
            height: clamp(250px, 40vw, 420px);
            overflow: hidden;
            position: relative;
            background: var(--bg2);
            margin-bottom: 60px;
        }

        .banner-container::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 60%, rgba(28,27,24,0.15));
        }

        .banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 8s var(--ease-out);
        }

        .banner-container:hover .banner-img {
            transform: scale(1.03);
        }

        /* ========================================
           VIDEO EMBED
           ======================================== */
        .embed-wrapper {
            margin-bottom: 70px;
            position: relative;
        }

        .embed-area {
            width: 100%;
            background: var(--ink);
            position: relative;
            overflow: hidden;
        }

        .embed-area iframe {
            width: 100%;
            aspect-ratio: 16/9;
            display: block;
            border: none;
        }

        /* ========================================
           PROJECT GRID
           ======================================== */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 0;
        }

        .project-card {
            cursor: pointer;
            position: relative;
            group: true;
        }

        .card-thumb-wrap {
            width: 100%;
            aspect-ratio: 4/3;
            overflow: hidden;
            background: var(--bg2);
            margin-bottom: 14px;
            position: relative;
        }

        .card-thumb-wrap::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.3s var(--ease);
            mix-blend-mode: multiply;
        }

        .project-card:hover .card-thumb-wrap::after {
            opacity: 0.08;
        }

        .card-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.5s var(--ease-out);
        }

        .project-card:hover .card-thumb {
            transform: scale(1.04);
        }

        .card-tag {
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .card-title {
            font-family: var(--serif);
            font-size: 1.15rem;
            font-weight: 400;
            line-height: 1.2;
            color: var(--ink);
            transition: color 0.2s;
        }

        .project-card:hover .card-title {
            color: var(--accent);
        }

        .card-arrow {
            display: inline-block;
            margin-left: 6px;
            opacity: 0;
            transform: translateX(-4px);
            transition: all 0.2s var(--ease);
        }

        .project-card:hover .card-arrow {
            opacity: 1;
            transform: translateX(0);
        }

        /* ========================================
           SKETCHBOOK
           ======================================== */
        .sketch-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 4rem;
        }

        .sketch-item {
            aspect-ratio: 1/1;
            overflow: hidden;
            cursor: zoom-in;
            position: relative;
            background: var(--bg2);
        }

        .sketch-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: all 0.4s var(--ease);
            filter: grayscale(80%);
        }

        .sketch-item:hover img {
            transform: scale(1.08);
            filter: grayscale(0%);
        }

        /* ========================================
           BLOG / NOTES
           ======================================== */
        .blog-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
            border-top: 1.5px solid var(--ink);
            margin-bottom: 4rem;
        }

        .blog-item {
            padding: 32px 24px 32px 0;
            border-bottom: 1px solid var(--rule);
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }

        .blog-item:nth-child(even) {
            padding-left: 24px;
            padding-right: 0;
            border-left: 1px solid var(--rule);
        }

        .blog-item:hover {
            background: var(--bg2);
        }

        .blog-date {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            display: block;
            margin-bottom: 12px;
        }

        .blog-thumb {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
            background: var(--bg2);
            margin-bottom: 16px;
            transition: opacity 0.3s;
        }

        .blog-item:hover .blog-thumb { opacity: 0.9; }

        .blog-title {
            font-family: var(--serif);
            font-size: 1.4rem;
            font-weight: 400;
            line-height: 1.2;
            margin-bottom: 12px;
            color: var(--ink);
        }

        .blog-excerpt {
            font-size: 0.85rem;
            color: var(--ink-soft);
            line-height: 1.6;
            font-style: italic;
        }

        /* ========================================
           ART GALLERY
           ======================================== */
        .gallery-header {
            margin: 4rem 0 3rem;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: end;
            border-bottom: 1.5px solid var(--ink);
            padding-bottom: 20px;
        }

        .gallery-h1 {
            font-family: var(--serif);
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 400;
            line-height: 1;
        }

        .gallery-sub {
            font-family: var(--mono);
            font-size: 0.7rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .art-gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            align-items: start;
            margin-bottom: 4rem;
        }

        .art-item {
            position: relative;
            break-inside: avoid;
        }

        .art-img {
            width: 100%;
            height: auto;
            display: block;
            background: var(--bg2);
            transition: opacity 0.3s;
        }

        .art-item:hover .art-img { opacity: 0.9; }

        .art-caption {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--ink-pale);
            letter-spacing: 0.08em;
            padding: 10px 0 0;
            text-transform: uppercase;
        }

        /* ========================================
           DETAIL VIEW
           ======================================== */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--ink-soft);
            cursor: pointer;
            padding: 20px 0;
            transition: color 0.2s;
            user-select: none;
        }

        .back-btn:hover { color: var(--ink); }

        .detail-container {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .detail-header {
            border-bottom: 1.5px solid var(--ink);
            padding-bottom: 32px;
            margin-bottom: 10px;
        }

        .detail-tag {
            font-family: var(--mono);
            font-size: 0.68rem;
            color: var(--accent);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .detail-title {
            font-family: var(--serif);
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 400;
            line-height: 1;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }

        .detail-desc {
            font-size: 1.05rem;
            color: var(--ink-soft);
            font-style: italic;
            line-height: 1.7;
            max-width: 65ch;
        }

        .detail-meta {
            display: flex;
            gap: 32px;
            margin-top: 24px;
        }

        .meta-item { }
        .meta-label {
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .meta-value {
            font-size: 0.85rem;
            color: var(--ink);
        }

        .generic-block { position: relative; }

        .generic-text {
            font-family: var(--sans);
            font-size: 1rem;
            line-height: 1.8;
            color: var(--ink-soft);
            white-space: pre-wrap;
        }

        .generic-img {
            width: 100%;
            height: auto;
            display: block;
            background: var(--bg2);
        }

        /* ========================================
           CONTACT
           ======================================== */
        #contact-view {
            padding: 5rem 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 80px;
            align-items: start;
        }

        .contact-left { }

        .contact-h1 {
            font-family: var(--serif);
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 400;
            line-height: 1.1;
            margin-bottom: 24px;
        }

        .contact-body {
            font-size: 1rem;
            color: var(--ink-soft);
            line-height: 1.7;
            font-style: italic;
            margin-bottom: 32px;
        }

        .contact-email {
            font-family: var(--mono);
            font-size: 0.9rem;
            color: var(--ink);
            text-decoration: none;
            border-bottom: 1px solid var(--ink);
            padding-bottom: 2px;
            transition: color 0.2s;
        }

        .contact-email:hover { color: var(--accent); border-color: var(--accent); }

        .contact-right { padding-top: 10px; }

        .contact-img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            display: block;
            background: var(--bg2);
            margin-bottom: 24px;
            filter: grayscale(30%);
        }

        .btn-cv {
            display: inline-block;
            padding: 12px 28px;
            background: var(--ink);
            color: var(--white);
            font-family: var(--mono);
            font-size: 0.7rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            margin-bottom: 24px;
        }

        .btn-cv:hover {
            background: var(--accent);
        }

        .social-row {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .social-link {
            font-family: var(--mono);
            font-size: 0.68rem;
            color: var(--ink-soft);
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: color 0.2s;
        }

        .social-link:hover { color: var(--accent); }

        /* ========================================
           LIGHTBOX
           ======================================== */
        #lightbox {
            position: fixed;
            inset: 0;
            background: rgba(28, 27, 24, 0.97);
            z-index: 8000;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }

        #lightbox.open { display: flex; }

        #lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
        }

        /* EDITOR-ONLY-START */
        /* Star / feature button on project cards */
        .star-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--rule);
            border-radius: 2px;
            width: 28px;
            height: 28px;
            font-size: 0.85rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--ink-pale);
            z-index: 5;
            transition: color 0.2s, background 0.2s;
            line-height: 1;
            padding: 0;
        }
        .star-btn:hover { color: #c8a000; background: #fff; }
        .star-btn.star-on { color: #c8a000; background: #fffbe6; border-color: #c8a000; }

        /* Show star button only in editing mode */
        body.editing-mode .star-btn { display: flex; }

        /* Hint shown only in editing mode */
        .editor-only-el { display: none; }
        body.editing-mode .editor-only-el { display: block; }

        /* Embed edit button */
        .embed-edit-btn {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--ink);
            color: var(--white);
            border: none;
            padding: 6px 12px;
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            z-index: 20;
            align-items: center;
            gap: 5px;
            transition: background 0.15s;
        }
        .embed-edit-btn:hover { background: var(--accent2); }

        /* ========================================
           FREE BLOCKS ‚Äî drag, resize, toolbar
           ======================================== */
        .free-block {
            position: absolute;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1.5px solid transparent;
            transition: border-color 0.15s;
            display: flex;
            flex-direction: column;
            min-width: 120px;
            min-height: 60px;
        }

        .free-block.fb-selected {
            border-color: var(--accent2);
            box-shadow: 0 4px 24px rgba(45,90,142,0.18);
        }

        /* Toolbar ‚Äî vis√≠vel s√≥ quando selected */
        .fb-toolbar {
            display: none;
            align-items: center;
            gap: 2px;
            background: var(--ink);
            padding: 5px 8px;
            position: absolute;
            top: -38px;
            left: 0;
            white-space: nowrap;
            z-index: 10;
            border-radius: 3px 3px 0 0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
        }

        .free-block.fb-selected .fb-toolbar { display: flex; }

        .fb-tool {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: rgba(255,255,255,0.75);
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 2px;
            transition: background 0.15s, color 0.15s;
            line-height: 1;
        }

        .fb-tool:hover { background: rgba(255,255,255,0.12); color: #fff; }

        .fb-drag-handle {
            cursor: grab;
            font-size: 1rem;
            padding: 2px 6px;
            letter-spacing: -2px;
            color: rgba(255,255,255,0.45);
        }

        .fb-drag-handle:hover { color: rgba(255,255,255,0.9); }
        .fb-drag-handle:active { cursor: grabbing; }

        .fb-sep {
            width: 1px;
            height: 14px;
            background: rgba(255,255,255,0.15);
            margin: 0 3px;
            padding: 0;
            cursor: default;
        }

        .fb-del {
            color: rgba(255,100,80,0.7) !important;
            margin-left: 2px;
        }
        .fb-del:hover { background: rgba(193,68,14,0.3) !important; color: #fff !important; }

        select.fb-tool {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.75);
            font-family: var(--mono);
            font-size: 0.62rem;
            padding: 2px 4px;
            cursor: pointer;
            outline: none;
        }

        select.fb-tool option { background: #222; color: #fff; }

        /* Text content area */
        .fb-text .fb-content {
            flex: 1;
            padding: 16px 18px;
            outline: none;
            background: var(--white);
            line-height: 1.6;
            color: var(--ink);
            min-height: 80px;
            cursor: text;
            overflow: auto;
        }

        .fb-text .fb-content:empty::before {
            content: 'Clique para editar...';
            color: var(--ink-pale);
            font-style: italic;
        }

        /* Image content area */
        .fb-image .fb-content {
            flex: 1;
            overflow: hidden;
            background: var(--bg2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fb-image .fb-content img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Resize handle */
        .fb-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 22px;
            height: 22px;
            cursor: nwse-resize;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--accent2);
            background: rgba(255,255,255,0.85);
            border-top: 1px solid var(--rule);
            border-left: 1px solid var(--rule);
            line-height: 1;
            user-select: none;
        }

        .free-block.fb-selected .fb-resize { display: flex; }

        /* Prevent toolbar from triggering drag on its own elements */
        .fb-toolbar * { user-select: none; }

        /* ========================================
           EDITOR PANEL
           ======================================== */
        #editor-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--ink);
            color: var(--white);
            padding: 12px 24px;
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 7000;
            flex-wrap: wrap;
            border-top: 2px solid var(--accent);
        }

        .editor-label {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--ink-pale);
            margin-right: 4px;
        }

        .btn {
            padding: 7px 14px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.7);
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn:hover {
            border-color: rgba(255,255,255,0.7);
            color: var(--white);
        }

        .btn-main {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--white);
        }

        .btn-main:hover {
            background: #a33608;
            border-color: #a33608;
        }

        .btn-save {
            background: var(--accent2);
            border-color: var(--accent2);
            color: var(--white);
        }

        .btn-save:hover {
            background: #234a75;
            border-color: #234a75;
        }

        .editor-divider {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            margin: 0 4px;
        }

        #edit-tools {
            display: none;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Edit states */
        [contenteditable="true"] {
            outline: 1.5px dashed rgba(193,68,14,0.4);
            background: rgba(193,68,14,0.03);
            border-radius: 1px;
            cursor: text;
        }

        [contenteditable="true"]:focus {
            outline: 2px solid var(--accent);
            background: rgba(255,255,255,0.5);
        }

        .editable-img:hover {
            outline: 2px solid var(--accent);
            cursor: pointer;
            opacity: 0.8;
        }

        .editable-link.editing {
            outline: 1px dashed var(--accent2);
            cursor: pointer;
            background: rgba(45,90,142,0.05);
        }

        .delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 8px;
            z-index: 10;
            cursor: pointer;
            display: none;
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* Sync indicator no editor panel */
        .sync-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--ink-pale);
            display: inline-block;
            margin-right: 4px;
            transition: background 0.3s;
        }
        .sync-dot.synced  { background: #3a8a3a; }
        .sync-dot.pending { background: #c19a0e; animation: pulse-dot 1.2s infinite; }
        .sync-dot.error   { background: var(--accent); }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.3; }
        }
        /* EDITOR-ONLY-END */

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 900px) {
            .container { width: 92%; }
            header { grid-template-columns: 1fr; gap: 16px; }
            .header-right { align-items: flex-start; flex-direction: row; justify-content: space-between; }
            .project-grid { grid-template-columns: 1fr 1fr; }
            .art-gallery-grid { grid-template-columns: 1fr 1fr; }
            .blog-grid { grid-template-columns: 1fr; }
            .blog-item:nth-child(even) { border-left: none; padding-left: 0; }
            .sketch-grid { grid-template-columns: repeat(3, 1fr); }
            #contact-view { grid-template-columns: 1fr; gap: 40px; }
            nav { flex-wrap: wrap; gap: 0; }
        }

        @media (max-width: 600px) {
            .project-grid { grid-template-columns: 1fr; }
            .art-gallery-grid { grid-template-columns: 1fr; }
            .sketch-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* EDITOR-ONLY-START */
        /* ========================================
           GIST SYNC MODAL
           ======================================== */
        #sync-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(28, 27, 24, 0.85);
            z-index: 8500;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        #sync-modal-backdrop.open { display: flex; }

        #sync-modal {
            background: var(--bg);
            border: 1.5px solid var(--ink);
            width: min(520px, 92vw);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .sync-modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--rule);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-modal-title {
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--ink);
        }

        .sync-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-family: var(--mono);
            font-size: 0.72rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            transition: color 0.2s;
        }
        .sync-modal-close:hover { color: var(--accent); }

        .sync-modal-body { padding: 24px; }

        .sync-field { margin-bottom: 20px; }

        .sync-label {
            display: block;
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--ink-pale);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .sync-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--white);
            border: 1px solid var(--rule);
            font-family: var(--mono);
            font-size: 0.8rem;
            color: var(--ink);
            outline: none;
            transition: border-color 0.2s;
        }
        .sync-input:focus { border-color: var(--ink); }
        .sync-input::placeholder { color: var(--ink-pale); }

        .sync-hint {
            font-size: 0.75rem;
            color: var(--ink-pale);
            margin-top: 6px;
            line-height: 1.5;
            font-style: italic;
        }
        .sync-hint a { color: var(--accent2); }

        .sync-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 24px;
        }

        .sync-btn {
            padding: 12px 16px;
            border: 1.5px solid var(--ink);
            background: transparent;
            font-family: var(--mono);
            font-size: 0.68rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            color: var(--ink);
            transition: all 0.2s var(--ease);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .sync-btn:hover { background: var(--ink); color: var(--white); }
        .sync-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .sync-btn-push { border-color: var(--accent); color: var(--accent); }
        .sync-btn-push:hover { background: var(--accent); color: var(--white); border-color: var(--accent); }

        .sync-btn-pull { border-color: var(--accent2); color: var(--accent2); }
        .sync-btn-pull:hover { background: var(--accent2); color: var(--white); border-color: var(--accent2); }

        .sync-status {
            margin-top: 16px;
            padding: 10px 14px;
            font-family: var(--mono);
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            border-left: 3px solid var(--rule);
            color: var(--ink-soft);
            min-height: 40px;
            display: none;
            line-height: 1.5;
        }
        .sync-status.visible { display: block; }
        .sync-status.ok   { border-color: #3a8a3a; color: #3a8a3a; }
        .sync-status.err  { border-color: var(--accent); color: var(--accent); }
        .sync-status.info { border-color: var(--accent2); color: var(--accent2); }

        .sync-divider {
            border: none;
            border-top: 1px solid var(--rule);
            margin: 20px 0;
        }

        .sync-section-title {
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--ink-pale);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 14px;
        }

        .sync-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .sync-info-item { }
        .sync-info-label {
            font-family: var(--mono);
            font-size: 0.58rem;
            color: var(--ink-pale);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        .sync-info-value {
            font-family: var(--mono);
            font-size: 0.75rem;
            color: var(--ink);
        }

        /* Sync indicator no editor panel */
        .sync-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--ink-pale);
            display: inline-block;
            margin-right: 4px;
            transition: background 0.3s;
        }
        .sync-dot.synced  { background: #3a8a3a; }
        .sync-dot.pending { background: #c19a0e; animation: pulse-dot 1.2s infinite; }
        .sync-dot.error   { background: var(--accent); }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.3; }
        }

        /* EDITOR-ONLY-END */

        /* ========================================
           PAGE ENTRY ANIMATION
           ======================================== */
        .fade-in {
            animation: fadeUp 0.4s var(--ease-out) both;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="lang-pt">

    <!-- LIGHTBOX -->
    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="">
    </div>

    <div class="container">

        <!-- HEADER -->
        <header>
            <div class="header-identity">
                <div class="header-name edit-text" contenteditable="false" data-save-id="header-name">Lucca Tuelher</div>
                <div class="header-role edit-text" contenteditable="false" data-save-id="header-role">Storyboard Artist &amp; Visual Storyteller</div>
            </div>
            <div class="header-right">
                <div class="lang-icons">
                    <button class="flag-btn" data-lang="pt" onclick="setLang('pt')" title="Portugu√™s">üáßüá∑</button>
                    <button class="flag-btn" data-lang="en" onclick="setLang('en')" title="English">üá∫üá∏</button>
                </div>
                <nav>
                    <a onclick="goHome()" class="nav-link active" id="nav-work">
                        <span class="pt-only">Home</span>
                        <span class="en-only">Home</span>
                    </a>
                    <a onclick="goProjects()" class="nav-link" id="nav-projects">
                        <span class="pt-only">Projetos</span>
                        <span class="en-only">Projects</span>
                    </a>
                    <a onclick="goGallery()" class="nav-link" id="nav-gallery">
                        <span class="pt-only">Galeria</span>
                        <span class="en-only">Gallery</span>
                    </a>
                    <a onclick="goBlog()" class="nav-link" id="nav-blog">
                        <span class="pt-only">Notas</span>
                        <span class="en-only">Notes</span>
                    </a>
                    <a onclick="togglePrivate()" class="nav-link private-btn" id="nav-private">
                        <span class="pt-only">Restrito</span>
                        <span class="en-only">Restricted</span>
                    </a>
                    <a onclick="goToContact()" class="nav-link" id="nav-contact">
                        <span class="pt-only">Contato</span>
                        <span class="en-only">Contact</span>
                    </a>
                </nav>
            </div>
        </header>

        <!-- Issue bar -->
        <div class="issue-bar">
            <span class="issue-text pt-only">Portfolio ‚Äî Visual Development &amp; Storyboard</span>
            <span class="issue-text en-only">Portfolio ‚Äî Visual Development &amp; Storyboard</span>
            <span class="issue-text" id="issue-date"></span>
        </div>

        <!-- HOME VIEW -->
        <div id="home-view">

            <div class="banner-container">
                <img src="https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1600&q=80" class="banner-img" alt="Banner">
            </div>

            <div class="embed-wrapper">
                <div class="embed-area edit-embed">
                    <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" allowfullscreen></iframe>
                </div>
            </div>

            <div class="section-title">
                <span class="section-label pt-only">Selecionados</span>
                <span class="section-label en-only">Featured</span>
                <div class="section-rule"></div>
                <span class="section-num" id="proj-count">‚Äî</span>
            </div>

            <!-- Home shows only featured cards (max 3), populated by renderFeatured() -->
            <div id="featured-grid" class="project-grid"></div>

            <div class="section-title">
                <span class="section-label">Sketchbook</span>
                <div class="section-rule"></div>
                <span class="section-num" id="sketch-count">‚Äî</span>
            </div>

            <div id="sketch-grid" class="sketch-grid"></div>

        </div>

        <!-- PROJECTS VIEW ‚Äî all projects, with featured picker -->
        <div id="projects-view" class="hidden">
            <div class="section-title" style="margin-top: 3rem;">
                <span class="section-label pt-only">Todos os Projetos</span>
                <span class="section-label en-only">All Projects</span>
                <div class="section-rule"></div>
                <span class="section-num" id="all-proj-count">‚Äî</span>
            </div>
            <p id="featured-hint" style="font-family:var(--mono);font-size:0.7rem;color:var(--ink-pale);letter-spacing:0.08em;margin-bottom:28px;" class="editor-only-el">
                Clique em ‚òÖ para destacar na Home (m√°x. 3) / Click ‚òÖ to feature on Home (max 3)
            </p>
            <div id="public-grid" class="project-grid"></div>
        </div>

        <!-- GALLERY VIEW -->
        <div id="gallery-view" class="hidden">
            <div class="gallery-header">
                <div>
                    <div class="gallery-h1 pt-only">Galeria de Arte</div>
                    <div class="gallery-h1 en-only">Art Gallery</div>
                </div>
                <div class="gallery-sub edit-text" contenteditable="false">
                    <span class="pt-only">Ilustra√ß√µes &amp; Processo</span>
                    <span class="en-only">Illustrations &amp; Process</span>
                </div>
            </div>
            <div id="art-gallery-container" class="art-gallery-grid"></div>
        </div>

        <!-- BLOG VIEW -->
        <div id="blog-view" class="hidden">
            <div class="section-title" style="margin-top: 3rem;">
                <span class="section-label pt-only">Notas &amp; Reflex√µes</span>
                <span class="section-label en-only">Notes &amp; Thoughts</span>
                <div class="section-rule"></div>
                <span class="section-num" id="blog-count">‚Äî</span>
            </div>
            <div id="blog-grid-container" class="blog-grid"></div>
        </div>

        <!-- PRIVATE VIEW -->
        <div id="private-view" class="hidden">
            <div class="section-title" style="margin-top: 3rem;">
                <span class="section-label" style="color: var(--accent);">NDA / Restricted</span>
                <div class="section-rule"></div>
                <span class="section-num">üîí</span>
            </div>
            <div id="private-grid" class="project-grid"></div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="detail-view" class="hidden">
            <div onclick="goBack()" class="back-btn">
                ‚Üê <span class="pt-only">Voltar</span><span class="en-only">Back</span>
            </div>
            <div id="detail-content" class="detail-container"></div>
        </div>

        <!-- CONTACT VIEW -->
        <div id="contact-view" class="hidden">
            <div class="contact-left">
                <div class="contact-h1 pt-only edit-text" contenteditable="false">Vamos<br>trabalhar<br>juntos.</div>
                <div class="contact-h1 en-only edit-text" contenteditable="false">Let's<br>work<br>together.</div>
                <div class="contact-body edit-text pt-only" contenteditable="false">
                    Dispon√≠vel para projetos freelance em storyboard, anima√ß√£o e desenvolvimento visual.
                </div>
                <div class="contact-body edit-text en-only" contenteditable="false">
                    Available for freelance projects in storyboard, animation, and visual development.
                </div>
                <a href="/cdn-cgi/l/email-protection#543821373735202131383c3126142d353c3b3b7a373b39" class="contact-email editable-link"><span class="__cf_email__" data-cfemail="d5b9a0b6b6b4a1a0b0b9bdb0a795acb4bdbabafbb6bab8">[email&#160;protected]</span></a>
                <div style="margin-top: 32px;">
                    <a href="cv.pdf" class="btn-cv editable-link" target="_blank">
                        <span class="pt-only">Baixar CV</span>
                        <span class="en-only">Download CV</span>
                    </a>
                </div>
                <div class="social-row" style="margin-top: 24px;">
                    <a href="#" class="social-link editable-link">LinkedIn</a>
                    <a href="#" class="social-link editable-link">Instagram</a>
                    <a href="#" class="social-link editable-link">Behance</a>
                </div>
            </div>
            <div class="contact-right">
                <img src="https://via.placeholder.com/400x533" class="contact-img editable-img" alt="Foto">
            </div>
        </div>

    </div><!-- /container -->

    <!-- EDITOR PANEL -->
    <div id="editor-panel">
        <span class="editor-label">Editor</span>
        <button onclick="toggleEdit()" id="btn-toggle" class="btn btn-main">Ativar Edi√ß√£o</button>
        <div id="edit-tools" style="display:none; gap:6px; align-items:center; flex-wrap:wrap;">
            <div class="editor-divider"></div>
            <button onclick="addProject('public')" class="btn">+ Projeto</button>
            <button onclick="addProject('private')" class="btn" style="color: #f5a87a; border-color: rgba(245,168,122,0.4);">+ Privado</button>
            <button onclick="addPost()" class="btn">+ Post</button>
            <button onclick="addGalleryItem()" class="btn">+ Arte</button>
            <button onclick="addSketch()" class="btn">+ Sketch</button>
            <div class="editor-divider"></div>
            <button onclick="addBlock('text')" class="btn">+ Texto</button>
            <button onclick="addBlock('image')" class="btn">+ Imagem</button>
            <div class="editor-divider"></div>
            <button onclick="exportJSON()" class="btn">Backup</button>
            <button onclick="importJSON()" class="btn">Restaurar</button>
            <div class="editor-divider"></div>
            <button onclick="openSyncModal()" class="btn" id="btn-sync" style="display:flex;align-items:center;gap:5px;">
                <span class="sync-dot" id="sync-dot"></span>‚òÅ Gist Sync
            </button>
            <button onclick="downloadSite()" id="btn-save" class="btn btn-save" title="Salva no navegador (localStorage) ‚Äî sem precisar baixar arquivo">üíæ Salvar</button>
            <button onclick="publishSite()" class="btn" style="background:var(--accent);border-color:var(--accent);color:#fff;" title="Gera portfolio-publico.html sem modo de edi√ß√£o">üöÄ Publicar Agora</button>
        </div>
    </div>

    <!-- GIST SYNC MODAL -->
    <div id="sync-modal-backdrop">
        <div id="sync-modal">
            <div class="sync-modal-header">
                <span class="sync-modal-title">‚òÅ Sincronizar via GitHub Gist</span>
                <button class="sync-modal-close" onclick="closeSyncModal()">‚úï Fechar</button>
            </div>
            <div class="sync-modal-body">

                <div class="sync-section-title">Credenciais</div>

                <div class="sync-field">
                    <label class="sync-label" for="gist-token">
                        GitHub Personal Access Token <span style="color:var(--accent);">*</span>
                    </label>
                    <input type="password" id="gist-token" class="sync-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
                    <div class="sync-hint">
                        Precisa da permiss√£o <strong>gist</strong>.
                        <a href="https://github.com/settings/tokens/new?scopes=gist&description=Portfolio+Sync" target="_blank">Gerar token ‚Üí</a><br>
                        O token fica salvo apenas no localStorage deste navegador.
                    </div>
                </div>

                <div class="sync-field">
                    <label class="sync-label" for="gist-id">
                        Gist ID <span style="color:var(--ink-pale);">(vazio = criar novo)</span>
                    </label>
                    <input type="text" id="gist-id" class="sync-input" placeholder="a1b2c3d4e5f6... (32 caracteres)">
                    <div class="sync-hint">
                        URL do Gist: gist.github.com/<em>usuario</em>/<strong>ID</strong>
                    </div>
                </div>

                <div class="sync-actions">
                    <button class="sync-btn sync-btn-push" onclick="gistPush()" id="btn-push">‚Üë Enviar (Push)</button>
                    <button class="sync-btn sync-btn-pull" onclick="gistPull()" id="btn-pull">‚Üì Receber (Pull)</button>
                </div>

                <div id="sync-status" class="sync-status"></div>

                <hr class="sync-divider">

                <div class="sync-section-title">Estado atual</div>
                <div class="sync-info-grid">
                    <div class="sync-info-item">
                        <div class="sync-info-label">√öltimo push</div>
                        <div class="sync-info-value" id="info-last-push">‚Äî</div>
                    </div>
                    <div class="sync-info-item">
                        <div class="sync-info-label">√öltimo pull</div>
                        <div class="sync-info-value" id="info-last-pull">‚Äî</div>
                    </div>
                    <div class="sync-info-item">
                        <div class="sync-info-label">Gist ID salvo</div>
                        <div class="sync-info-value" id="info-gist-id">‚Äî</div>
                    </div>
                    <div class="sync-info-item">
                        <div class="sync-info-label">Tamanho dos dados</div>
                        <div class="sync-info-value" id="info-data-size">‚Äî</div>
                    </div>
                </div>

                <hr class="sync-divider">

                <div class="sync-section-title">Como usar</div>
                <div class="sync-hint" style="line-height:1.9;">
                    <strong>1.</strong> Crie um token no GitHub com permiss√£o <code>gist</code>.<br>
                    <strong>2.</strong> Clique em <strong>Enviar (Push)</strong> ‚Üí salva os dados em um Gist secreto.<br>
                    <strong>3.</strong> Copie o Gist ID exibido na confirma√ß√£o.<br>
                    <strong>4.</strong> Em outro computador, cole o token + Gist ID e clique em <strong>Receber (Pull)</strong>.<br>
                    <strong>‚ö†</strong> Imagens base64 aumentam muito o tamanho. Para imagens grandes, prefira URLs externas (Imgur, Cloudinary).
                </div>

            </div>
        </div>
    </div>

    <input type="file" id="file-input" style="display:none;" accept="image/*">
    <input type="file" id="json-input" style="display:none;" accept=".json">

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // CONSTANTS & STATE
        // ============================================
        const SITE_PASSWORD = "nda";
        let isEditing = false;
        let currentImg = null;
        let currentLang = 'pt';
        let previousView = 'home';

        // DOM refs
        const views = {
            home:     document.getElementById('home-view'),
            projects: document.getElementById('projects-view'),
            blog:     document.getElementById('blog-view'),
            gallery:  document.getElementById('gallery-view'),
            private:  document.getElementById('private-view'),
            detail:   document.getElementById('detail-view'),
            contact:  document.getElementById('contact-view')
        };
        const navs = {
            work:     document.getElementById('nav-work'),
            projects: document.getElementById('nav-projects'),
            blog:     document.getElementById('nav-blog'),
            gallery:  document.getElementById('nav-gallery'),
            private:  document.getElementById('nav-private'),
            contact:  document.getElementById('nav-contact')
        };

        // ============================================
        // INIT
        // ============================================
        function init() {
            // Issue date
            const d = new Date();
            document.getElementById('issue-date').textContent = d.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });

            // Sketch click handlers
            document.querySelectorAll('.sketch-item img').forEach(img => {
                img.onclick = () => openLightbox(img.src);
            });

            // Restore star states from localStorage
            const featured = getFeaturedIds();
            document.querySelectorAll('.star-btn').forEach(btn => {
                const card = btn.closest('.project-card');
                if (card && featured.includes(card.dataset.itemId)) {
                    btn.classList.add('star-on');
                    btn.title = 'Remover destaque';
                }
            });

            renderFeatured();
            updateCounts();
        }

        // ============================================
        // LANGUAGE
        // ============================================
        function setLang(lang) {
            currentLang = lang;
            document.body.className = 'lang-' + lang;
            if (isEditing) document.body.classList.add('editing-mode');
        }

        // ============================================
        // VIEW NAVIGATION
        // ============================================
        function resetViews() {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navs).forEach(n => n.classList.remove('active'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showView(viewKey, navKey) {
            resetViews();
            views[viewKey].classList.remove('hidden');
            views[viewKey].classList.add('fade-in');
            setTimeout(() => views[viewKey].classList.remove('fade-in'), 500);
            if (navKey && navs[navKey]) navs[navKey].classList.add('active');
        }

        function goHome()      { showView('home', 'work');         previousView = 'home'; renderFeatured(); updateCounts(); }
        function goProjects()  { showView('projects', 'projects'); previousView = 'projects'; updateCounts(); }
        function goBlog()      { showView('blog', 'blog');         previousView = 'blog'; updateCounts(); }
        function goGallery()   { showView('gallery', 'gallery');   previousView = 'gallery'; }
        function goToContact() { showView('contact', 'contact'); }

        function togglePrivate() {
            if (isEditing) { showView('private', 'private'); previousView = 'private'; return; }
            if (!views.private.classList.contains('hidden')) { goHome(); return; }
            const pass = prompt("Senha / Password:");
            if (pass === SITE_PASSWORD) {
                showView('private', 'private');
                previousView = 'private';
            } else if (pass !== null) {
                alert("Acesso negado.");
            }
        }

        function goBack() {
            if (previousView === 'blog')         goBlog();
            else if (previousView === 'gallery')  goGallery();
            else if (previousView === 'projects') goProjects();
            else if (previousView === 'private')  { showView('private', 'private'); }
            else goHome();
        }

        // ============================================
        // FEATURED PROJECTS (Home shows max 3)
        // ============================================

        // Returns array of featured project IDs (stored in localStorage)
        function getFeaturedIds() {
            try { return JSON.parse(localStorage.getItem('portfolio_featured') || '[]'); }
            catch(e) { return []; }
        }
        function saveFeaturedIds(ids) {
            localStorage.setItem('portfolio_featured', JSON.stringify(ids));
        }

        // Toggle featured state of a project card
        function toggleFeatured(id, btn) {
            let featured = getFeaturedIds();
            if (featured.includes(id)) {
                featured = featured.filter(f => f !== id);
                btn.classList.remove('star-on');
                btn.title = 'Destacar na Home';
            } else {
                if (featured.length >= 3) {
                    alert('M√°ximo 3 projetos em destaque na Home.\nRemova um antes de adicionar outro.');
                    return;
                }
                featured.push(id);
                btn.classList.add('star-on');
                btn.title = 'Remover destaque';
            }
            saveFeaturedIds(featured);
            renderFeatured();
            updateCounts();
        }

        // Rebuild the featured-grid on Home from the full public-grid
        function renderFeatured() {
            const featuredGrid = document.getElementById('featured-grid');
            if (!featuredGrid) return;
            const featured = getFeaturedIds();
            const allCards = Array.from(document.querySelectorAll('#public-grid .project-card'));

            featuredGrid.innerHTML = '';

            // If no featured set yet, show the first 3 cards
            const toShow = featured.length > 0
                ? allCards.filter(c => featured.includes(c.dataset.itemId))
                : allCards.slice(0, 3);

            toShow.forEach(originalCard => {
                // Clone the card (visual copy only, no star button)
                const clone = originalCard.cloneNode(true);
                clone.querySelectorAll('.delete-btn, .star-btn').forEach(el => el.remove());
                // Re-attach click delegation via data-item-id
                featuredGrid.appendChild(clone);
            });

            // Update featured count label
            const pc = document.getElementById('proj-count');
            if (pc) pc.textContent = toShow.length > 0 ? String(toShow.length).padStart(2,'0') : '‚Äî';
        }

        function openItem(id) {
            const contentDiv = document.getElementById('detail-content');
            const source = document.getElementById('data-' + id);
            if (!source) return;
            resetViews();
            views.detail.classList.remove('hidden');
            contentDiv.innerHTML = '';
            source.classList.remove('hidden');
            contentDiv.appendChild(source);
        }

        // ============================================
        // LIGHTBOX
        // ============================================
        function openLightbox(src) {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').classList.add('open');
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('open');
        }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });

        // ============================================
        // COUNTS
        // ============================================
        function updateCounts() {
            const allProjCount   = document.querySelectorAll('#public-grid .project-card').length;
            const sketchCount    = document.querySelectorAll('#sketch-grid .sketch-item').length;
            const blogCount      = document.querySelectorAll('#blog-grid-container .blog-item').length;

            const apc = document.getElementById('all-proj-count');
            const sc  = document.getElementById('sketch-count');
            const bc  = document.getElementById('blog-count');

            if (apc) apc.textContent = allProjCount > 0 ? String(allProjCount).padStart(2,'0') : '‚Äî';
            if (sc)  sc.textContent  = sketchCount  > 0 ? String(sketchCount).padStart(2,'0')  : '‚Äî';
            if (bc)  bc.textContent  = blogCount     > 0 ? String(blogCount).padStart(2,'0')    : '‚Äî';

            // proj-count on home is set by renderFeatured()
        }

        // ============================================
        // EDITOR
        // ============================================
        function toggleEdit() {
            isEditing = !isEditing;
            const btn = document.getElementById('btn-toggle');
            const tools = document.getElementById('edit-tools');

            if (isEditing) {
                btn.textContent = 'Parar Edi√ß√£o';
                btn.className = 'btn';
                btn.style.borderColor = 'rgba(255,255,255,0.4)';
                tools.style.display = 'flex';
                enableEditing(true);
            } else {
                btn.textContent = 'Ativar Edi√ß√£o';
                btn.className = 'btn btn-main';
                btn.style.borderColor = '';
                tools.style.display = 'none';
                enableEditing(false);
            }
        }

        function enableEditing(enable) {
            // Text
            document.querySelectorAll('.edit-text').forEach(el => {
                el.contentEditable = enable;
            });

            // Images
            document.querySelectorAll('img').forEach(img => {
                if (enable) {
                    img.classList.add('editable-img');
                    img.onclick = () => uploadImg(img);
                } else {
                    img.classList.remove('editable-img');
                    if (img.closest('.sketch-item')) {
                        img.onclick = () => openLightbox(img.src);
                    } else {
                        img.onclick = null;
                    }
                }
            });

            // Embeds ‚Äî show/hide the edit-embed-btn overlay
            document.querySelectorAll('.edit-embed').forEach(div => {
                let btn = div.parentElement.querySelector('.embed-edit-btn');
                if (enable) {
                    div.style.outline = '2px dashed rgba(45,90,142,0.4)';
                    if (!btn) {
                        btn = document.createElement('button');
                        btn.className = 'embed-edit-btn';
                        btn.innerHTML = '‚úè Editar v√≠deo';
                        btn.onclick = () => promptEmbed(div);
                        div.parentElement.appendChild(btn);
                    }
                    btn.style.display = 'flex';
                } else {
                    div.style.outline = '';
                    if (btn) btn.style.display = 'none';
                }
            });

            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.style.display = enable ? 'block' : 'none';
            });

            // Links
            document.querySelectorAll('.editable-link').forEach(link => {
                if (enable) {
                    link.classList.add('editing');
                    link.onclick = e => {
                        e.preventDefault();
                        const newUrl = prompt("Novo URL:", link.href || link.getAttribute('href'));
                        if (newUrl !== null) link.href = newUrl;
                    };
                } else {
                    link.classList.remove('editing');
                    link.onclick = null;
                }
            });
        }

        function promptEmbed(div) {
            const current = div.querySelector('iframe')?.src || '';
            const code = prompt("Cole a URL do YouTube ou embed code:", current);
            if (!code) return;
            if (code.includes('<iframe')) {
                div.innerHTML = code;
            } else {
                const src = code
                    .replace('watch?v=', 'embed/')
                    .replace('youtu.be/', 'www.youtube.com/embed/');
                div.innerHTML = `<iframe src="${src}" allowfullscreen></iframe>`;
            }
            autoSave();
        }

        // ============================================
        // IMAGE UPLOAD
        // ============================================
        function uploadImg(imgEl) {
            if (!isEditing) return;
            currentImg = imgEl;
            document.getElementById('file-input').click();
        }

        document.getElementById('file-input').addEventListener('change', function (e) {
            if (!e.target.files || !e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = ev => {
                if (currentImg) currentImg.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
            // Reset input
            this.value = '';
        });

        // ============================================
        // CONTENT CREATION
        // ============================================
        function createDataWrapper(id, innerHTML) {
            const div = document.createElement('div');
            div.id = `data-${id}`;
            div.className = 'hidden';
            div.innerHTML = innerHTML;
            document.body.appendChild(div);
            return div;
        }

        function addProject(type) {
            const id = 'proj_' + Date.now();
            const grid = type === 'public'
                ? document.getElementById('public-grid')
                : document.getElementById('private-grid');

            const card = document.createElement('div');
            card.className = 'project-card';
            card.dataset.itemId = id;
            card.innerHTML = `
                <button class="delete-btn" onclick="event.stopPropagation(); this.closest('.project-card').remove(); const d=document.getElementById('data-${id}'); if(d) d.remove(); saveFeaturedIds(getFeaturedIds().filter(x=>x!=='${id}')); renderFeatured(); updateCounts();">DEL</button>
                ${type === 'public' ? `<button class="star-btn" onclick="event.stopPropagation(); toggleFeatured('${id}', this);" title="Destacar na Home">‚òÖ</button>` : ''}
                <div class="card-thumb-wrap">
                    <img src="https://via.placeholder.com/600x450/e8e4db/5a574f" class="card-thumb">
                </div>
                <div class="card-tag edit-text pt-only" contenteditable="true">Categoria</div>
                <div class="card-tag edit-text en-only" contenteditable="true">Category</div>
                <h4 class="card-title edit-text pt-only" contenteditable="true">Novo Projeto</h4>
                <h4 class="card-title edit-text en-only" contenteditable="true">New Project</h4>
                <span class="card-arrow">‚Üí</span>`;
            grid.appendChild(card);

            createDataWrapper(id, `
                <div class="detail-header">
                    <div class="detail-tag edit-text" contenteditable="true">Storyboard</div>
                    <div class="detail-title edit-text pt-only" contenteditable="true">T√≠tulo do Projeto</div>
                    <div class="detail-title edit-text en-only" contenteditable="true">Project Title</div>
                    <div class="detail-desc edit-text pt-only" contenteditable="true">Descri√ß√£o curta do projeto, contexto e objetivos.</div>
                    <div class="detail-desc edit-text en-only" contenteditable="true">Short description of the project, context and goals.</div>
                    <div class="detail-meta">
                        <div class="meta-item"><div class="meta-label">Ano</div><div class="meta-value edit-text" contenteditable="true">2025</div></div>
                        <div class="meta-item"><div class="meta-label">Cliente</div><div class="meta-value edit-text" contenteditable="true">‚Äî</div></div>
                        <div class="meta-item"><div class="meta-label">Tipo</div><div class="meta-value edit-text" contenteditable="true">Storyboard</div></div>
                    </div>
                </div>
                <div class="embed-wrapper" style="margin-bottom:28px;">
                    <div class="embed-area edit-embed" style="aspect-ratio:16/9; display:flex; align-items:center; justify-content:center;">
                        <span style="color:#888; font-family:var(--mono); font-size:0.7rem; letter-spacing:0.1em;">[ Ative a edi√ß√£o e clique em "‚úè Editar v√≠deo" ]</span>
                    </div>
                </div>
                <div class="generic-block">
                    <button class="delete-btn" onclick="this.parentElement.remove();">DEL</button>
                    <img src="https://via.placeholder.com/1200x700/e8e4db/5a574f" class="generic-img editable-img">
                </div>`);

            updateCounts();
            renderFeatured();
            if (isEditing) enableEditing(true);
        }

        // Event delegation ‚Äî works even after contenteditable rename
        document.addEventListener('click', function(e) {
            if (isEditing) return;
            const card = e.target.closest('.project-card[data-item-id], .blog-item[data-item-id]');
            if (card) openItem(card.dataset.itemId);
        });

        function addPost() {
            const id = 'post_' + Date.now();
            const grid = document.getElementById('blog-grid-container');

            const item = document.createElement('div');
            item.className = 'blog-item';
            item.dataset.itemId = id;
            item.innerHTML = `
                <button class="delete-btn" onclick="event.stopPropagation(); this.parentElement.remove(); const d=document.getElementById('data-${id}'); if(d) d.remove(); updateCounts();">DEL</button>
                <span class="blog-date edit-text" contenteditable="true">01 JAN 2025</span>
                <img src="https://via.placeholder.com/600x338/e8e4db/5a574f" class="blog-thumb editable-img">
                <div class="blog-title edit-text pt-only" contenteditable="true">T√≠tulo da Nota</div>
                <div class="blog-title edit-text en-only" contenteditable="true">Note Title</div>
                <div class="blog-excerpt edit-text pt-only" contenteditable="true">Resumo breve do post...</div>
                <div class="blog-excerpt edit-text en-only" contenteditable="true">Brief excerpt...</div>`;
            grid.prepend(item);

            createDataWrapper(id, `
                <div class="detail-header">
                    <div class="detail-tag edit-text" contenteditable="true">Nota</div>
                    <div class="detail-title edit-text pt-only" contenteditable="true">T√≠tulo Completo</div>
                    <div class="detail-title edit-text en-only" contenteditable="true">Full Title</div>
                    <div class="detail-desc edit-text pt-only" contenteditable="true">Texto introdut√≥rio...</div>
                    <div class="detail-desc edit-text en-only" contenteditable="true">Introductory text...</div>
                </div>
                <div class="generic-block">
                    <button class="delete-btn" onclick="this.parentElement.remove();">DEL</button>
                    <img src="https://via.placeholder.com/1200x700/e8e4db/5a574f" class="generic-img editable-img">
                </div>
                <div class="generic-block">
                    <button class="delete-btn" onclick="this.parentElement.remove();">DEL</button>
                    <div class="generic-text edit-text" contenteditable="true">Conte√∫do do post. Clique para editar.</div>
                </div>`);

            updateCounts();
            if (isEditing) enableEditing(true);
        }

        function addGalleryItem() {
            const grid = document.getElementById('art-gallery-container');
            const item = document.createElement('div');
            item.className = 'art-item';
            item.innerHTML = `
                <button class="delete-btn" onclick="this.parentElement.remove();">DEL</button>
                <img src="https://via.placeholder.com/400x550/e8e4db/5a574f" class="art-img editable-img">
                <div class="art-caption edit-text pt-only" contenteditable="true">Descri√ß√£o</div>
                <div class="art-caption edit-text en-only" contenteditable="true">Caption</div>`;
            grid.appendChild(item);
            if (isEditing) enableEditing(true);
        }

        function addSketch() {
            const grid = document.getElementById('sketch-grid');
            const item = document.createElement('div');
            item.className = 'sketch-item';
            item.innerHTML = `
                <button class="delete-btn" onclick="this.parentElement.remove(); updateCounts();">DEL</button>
                <img src="https://via.placeholder.com/400x400/e8e4db/5a574f">`;
            grid.appendChild(item);
            if (isEditing) enableEditing(true);
            updateCounts();
        }

        // ============================================
        // FREE BLOCKS ‚Äî arrastar, redimensionar, editar
        // ============================================

        let _fbDragging = null, _fbResizing = null;
        let _fbOx = 0, _fbOy = 0, _fbOw = 0, _fbOh = 0, _fbOmx = 0, _fbOmy = 0;
        let _fbSelected = null;

        // Retorna a view vis√≠vel no momento
        function getActiveView() {
            return Object.values(views).find(v => v && !v.classList.contains('hidden')) || null;
        }

        // Desseleciona todos os blocos
        function deselectAllBlocks() {
            document.querySelectorAll('.free-block.fb-selected').forEach(b => {
                b.classList.remove('fb-selected');
            });
            _fbSelected = null;
        }

        // Clique fora deseleciona
        document.addEventListener('mousedown', function(e) {
            if (!isEditing) return;
            if (!e.target.closest('.free-block') && !e.target.closest('.fb-toolbar')) {
                deselectAllBlocks();
            }
        });

        // Mouse move global ‚Äî drag e resize
        document.addEventListener('mousemove', function(e) {
            if (_fbDragging) {
                const view = _fbDragging.closest('[id$="-view"], [id^="detail-content"]');
                if (!view) return;
                const vr = view.getBoundingClientRect();
                let x = e.clientX - _fbOx - vr.left;
                let y = e.clientY - _fbOy - vr.top + view.scrollTop;
                // Snap suave √†s bordas do container
                x = Math.max(0, x);
                y = Math.max(0, y);
                _fbDragging.style.left = x + 'px';
                _fbDragging.style.top  = y + 'px';
            }
            if (_fbResizing) {
                const dx = e.clientX - _fbOmx;
                const dy = e.clientY - _fbOmy;
                const nw = Math.max(120, _fbOw + dx);
                const nh = Math.max(60,  _fbOh + dy);
                _fbResizing.style.width  = nw + 'px';
                _fbResizing.style.height = (_fbResizing.dataset.type === 'text' ? 'auto' : nh + 'px');
                if (_fbResizing.dataset.type === 'text') {
                    _fbResizing.querySelector('.fb-content').style.minHeight = nh + 'px';
                }
            }
        });

        document.addEventListener('mouseup', function() {
            _fbDragging = null;
            _fbResizing = null;
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
        });

        // Cria um bloco livre e o insere na view ativa
        function addBlock(type) {
            if (!isEditing) return;

            const view = getActiveView();
            if (!view) return;

            // Posi√ß√£o inicial: centro vis√≠vel da view
            const vr = view.getBoundingClientRect();
            const scrollY = view.scrollTop || 0;
            const startX = Math.max(0, (vr.width  - 360) / 2);
            const startY = Math.max(0, scrollY + (vr.height - 240) / 2 - vr.top);

            const block = document.createElement('div');
            block.className = 'free-block fb-' + type;
            block.dataset.type = type;
            block.style.left   = startX + 'px';
            block.style.top    = startY + 'px';
            block.style.width  = (type === 'text' ? '380px' : '480px');
            block.style.height = (type === 'text' ? 'auto'  : '300px');

            // Toolbar
            const toolbar = document.createElement('div');
            toolbar.className = 'fb-toolbar';
            toolbar.innerHTML = `
                <span class="fb-tool fb-drag-handle" title="Arrastar">‚†ø</span>
                ${type === 'text' ? `
                <span class="fb-tool fb-sep"></span>
                <button class="fb-tool fb-fmt" data-cmd="bold"       title="Negrito"><b>B</b></button>
                <button class="fb-tool fb-fmt" data-cmd="italic"     title="It√°lico"><i>I</i></button>
                <button class="fb-tool fb-fmt" data-cmd="underline"  title="Sublinhado"><u>U</u></button>
                <span class="fb-tool fb-sep"></span>
                <select class="fb-tool fb-size" title="Tamanho">
                    <option value="0.8rem">XS</option>
                    <option value="1rem" selected>S</option>
                    <option value="1.3rem">M</option>
                    <option value="1.8rem">L</option>
                    <option value="2.6rem">XL</option>
                    <option value="3.6rem">XXL</option>
                </select>
                <select class="fb-tool fb-font" title="Fonte">
                    <option value="var(--sans)"  selected>Sans</option>
                    <option value="var(--serif)">Serif</option>
                    <option value="var(--mono)">Mono</option>
                </select>
                ` : `
                <span class="fb-tool fb-sep"></span>
                <button class="fb-tool fb-img-upload" title="Trocar imagem">üñº Trocar</button>
                `}
                <span class="fb-tool fb-sep"></span>
                <button class="fb-tool fb-del" title="Excluir">‚úï</button>`;

            // Content
            const content = document.createElement('div');
            content.className = 'fb-content';

            if (type === 'text') {
                content.contentEditable = 'true';
                content.innerHTML = 'Clique para editar...';
                content.style.fontFamily = 'var(--sans)';
                content.style.fontSize   = '1rem';
                // Prevent drag on text selection
                content.addEventListener('mousedown', e => e.stopPropagation());
            } else {
                const img = document.createElement('img');
                img.src = 'https://via.placeholder.com/480x300/e8e4db/a09c93';
                img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;';
                content.appendChild(img);
                content.style.height = '100%';
            }

            // Resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'fb-resize';
            resizeHandle.title = 'Redimensionar';
            resizeHandle.innerHTML = '‚§°';

            block.appendChild(toolbar);
            block.appendChild(content);
            block.appendChild(resizeHandle);

            // ---- Event: selecionar ----
            block.addEventListener('mousedown', function(e) {
                if (e.target.closest('.fb-toolbar') || e.target.closest('.fb-resize')) return;
                deselectAllBlocks();
                block.classList.add('fb-selected');
                _fbSelected = block;
            });

            // ---- Event: drag handle ----
            toolbar.querySelector('.fb-drag-handle').addEventListener('mousedown', function(e) {
                e.preventDefault();
                deselectAllBlocks();
                block.classList.add('fb-selected');
                _fbSelected = block;
                _fbDragging = block;
                const r = block.getBoundingClientRect();
                _fbOx = e.clientX - r.left;
                _fbOy = e.clientY - r.top;
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'grabbing';
            });

            // ---- Event: resize ----
            resizeHandle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                _fbResizing = block;
                _fbOw  = block.offsetWidth;
                _fbOh  = block.offsetHeight;
                _fbOmx = e.clientX;
                _fbOmy = e.clientY;
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'nwse-resize';
            });

            // ---- Event: delete ----
            toolbar.querySelector('.fb-del').addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Excluir este bloco?')) block.remove();
            });

            // ---- Event: text formatting ----
            if (type === 'text') {
                toolbar.querySelectorAll('.fb-fmt').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        content.focus();
                        document.execCommand(this.dataset.cmd, false, null);
                    });
                });

                toolbar.querySelector('.fb-size').addEventListener('change', function() {
                    content.style.fontSize = this.value;
                });

                toolbar.querySelector('.fb-font').addEventListener('change', function() {
                    content.style.fontFamily = this.value;
                });
            }

            // ---- Event: image upload ----
            if (type === 'image') {
                toolbar.querySelector('.fb-img-upload').addEventListener('click', function(e) {
                    e.stopPropagation();
                    currentImg = content.querySelector('img');
                    document.getElementById('file-input').click();
                });
            }

            // Inserir na view ‚Äî usa position relative como base
            view.style.position = 'relative';
            view.appendChild(block);

            // Selecionar imediatamente
            deselectAllBlocks();
            block.classList.add('fb-selected');
            _fbSelected = block;

            if (type === 'text') {
                setTimeout(() => { content.focus(); selectAll(content); }, 50);
            }
        }

        function selectAll(el) {
            const range = document.createRange();
            range.selectNodeContents(el);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // ============================================
        // PUBLISH ‚Äî gera site p√∫blico limpo
        // ============================================

        function publishSite() {
            if (isEditing) toggleEdit();

            // Bake featured state into cards as data-featured attribute before clone
            const featuredIds = getFeaturedIds();
            document.querySelectorAll('#public-grid .project-card[data-item-id]').forEach(card => {
                card.dataset.featured = featuredIds.includes(card.dataset.itemId) ? 'true' : 'false';
            });

            // Certifica que todos os dados est√£o no DOM
            const detailContent = document.getElementById('detail-content');
            if (detailContent && detailContent.children.length) {
                Array.from(detailContent.children).forEach(child => {
                    child.classList.add('hidden');
                    document.body.appendChild(child);
                });
            }

            // Clona o documento inteiro em mem√≥ria
            const doc = document.cloneNode(true);

            // ---- 1. Remover se√ß√£o privada e link ----
            const privateView = doc.getElementById('private-view');
            if (privateView) privateView.remove();

            const navPrivate = doc.getElementById('nav-private');
            if (navPrivate) navPrivate.remove();

            // ---- 2. Remover editor panel ----
            const editorPanel = doc.getElementById('editor-panel');
            if (editorPanel) editorPanel.remove();

            // ---- 3. Remover modal de sync ----
            const syncModal = doc.getElementById('sync-modal-backdrop');
            if (syncModal) syncModal.remove();

            // ---- 4. Remover inputs hidden (file, json) ----
            doc.querySelectorAll('#file-input, #json-input').forEach(el => el.remove());

            // ---- 4b. Converter free-blocks em elementos est√°ticos (sem toolbar/resize) ----
            doc.querySelectorAll('.free-block').forEach(block => {
                block.querySelector('.fb-toolbar')?.remove();
                block.querySelector('.fb-resize')?.remove();
                block.classList.remove('fb-selected');
                // Remove edit affordances, keep visual position
                if (block.dataset.type === 'text') {
                    const c = block.querySelector('.fb-content');
                    if (c) c.removeAttribute('contenteditable');
                }
            });

            // ---- 5. Limpar atributos de edi√ß√£o em todo conte√∫do ----
            doc.querySelectorAll('[contenteditable]').forEach(el => {
                el.removeAttribute('contenteditable');
            });
            doc.querySelectorAll('.edit-text').forEach(el => {
                el.classList.remove('edit-text');
            });
            doc.querySelectorAll('.editable-img').forEach(el => {
                el.classList.remove('editable-img');
            });
            doc.querySelectorAll('.editable-link').forEach(el => {
                el.classList.remove('editable-link');
            });
            doc.querySelectorAll('.edit-embed').forEach(el => {
                el.classList.remove('edit-embed');
            });

            // ---- 6. Remover bot√µes de delete ----
            doc.querySelectorAll('.delete-btn').forEach(el => el.remove());

            // ---- 7. Remover onclick inline de edi√ß√£o de embed ----
            // (os onclick de navega√ß√£o como openItem, goHome, etc. devem permanecer)

            // ---- 8. Mostrar home, esconder outras views ----
            const viewIds = ['home-view', 'projects-view', 'blog-view', 'gallery-view', 'detail-view', 'contact-view'];
            viewIds.forEach(id => {
                const el = doc.getElementById(id);
                if (!el) return;
                if (id === 'home-view') el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            // ---- 9. Reset nav: s√≥ work ativo ----
            doc.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const navWork = doc.getElementById('nav-work');
            if (navWork) navWork.classList.add('active');

            // ---- 10. Remover todo CSS do editor do <style> ----
            const styleBlocks = doc.querySelectorAll('style');
            styleBlocks.forEach(styleEl => {
                styleEl.textContent = stripEditorCSS(styleEl.textContent);
            });

            // ---- 11. Substituir o <script> inteiro pelo script p√∫blico m√≠nimo ----
            doc.querySelectorAll('script').forEach(el => el.remove());

            const publicScript = doc.createElement('script');
            publicScript.textContent = buildPublicScript();
            doc.body.appendChild(publicScript);

            // ---- 12. Ajustar padding-bottom do body (remover espa√ßo do editor) ----
            const bodyEl = doc.body;
            bodyEl.style.paddingBottom = '0';

            // ---- 13. Atualizar <title> ----
            const titleEl = doc.querySelector('title');
            if (titleEl) titleEl.textContent = 'Lucca Tuelher | Portfolio';

            // ---- 14. Serializar e download ----
            const serializer = new XMLSerializer();
            let html = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'portfolio-publico.html';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // Remove blocos de CSS marcados como editor-only do texto do style
        function stripEditorCSS(css) {
            // Remove entre os marcadores /* EDITOR-ONLY-START */ ‚Ä¶ /* EDITOR-ONLY-END */
            return css.replace(/\/\* EDITOR-ONLY-START \*\/[\s\S]*?\/\* EDITOR-ONLY-END \*\//g, '');
        }

        // Script m√≠nimo para o site p√∫blico: navega√ß√£o, lightbox, contadores, lang
        function buildPublicScript() {
            // Inject minimal CSS for free blocks (static, no editor chrome)
            const freeBlockCSS = `
        .free-block { position:absolute; z-index:100; }
        .fb-text .fb-content { padding:16px 18px; line-height:1.6; color:var(--ink); overflow:auto; }
        .fb-image .fb-content { height:100%; overflow:hidden; }
        .fb-image .fb-content img { width:100%; height:100%; object-fit:cover; display:block; }
        .fb-toolbar, .fb-resize { display:none !important; }`;

            return `
        (function() {
            // Inject free-block static styles
            var s = document.createElement('style');
            s.textContent = ${JSON.stringify(freeBlockCSS)};
            document.head.appendChild(s);
            // ---- Estado ----
            var currentLang = 'pt';
            var previousView = 'home';

            var views = {
                home:     document.getElementById('home-view'),
                projects: document.getElementById('projects-view'),
                blog:     document.getElementById('blog-view'),
                gallery:  document.getElementById('gallery-view'),
                detail:   document.getElementById('detail-view'),
                contact:  document.getElementById('contact-view')
            };
            var navs = {
                work:     document.getElementById('nav-work'),
                projects: document.getElementById('nav-projects'),
                blog:     document.getElementById('nav-blog'),
                gallery:  document.getElementById('nav-gallery'),
                contact:  document.getElementById('nav-contact')
            };

            // ---- Lang ----
            window.setLang = function(lang) {
                currentLang = lang;
                document.body.className = 'lang-' + lang;
            };

            // ---- Views ----
            function resetViews() {
                Object.values(views).forEach(function(v) { if(v) v.classList.add('hidden'); });
                Object.values(navs).forEach(function(n) { if(n) n.classList.remove('active'); });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function showView(key, navKey) {
                resetViews();
                if (views[key]) {
                    views[key].classList.remove('hidden');
                    views[key].classList.add('fade-in');
                    setTimeout(function(){ views[key].classList.remove('fade-in'); }, 500);
                }
                if (navKey && navs[navKey]) navs[navKey].classList.add('active');
            }

            window.goHome    = function() { showView('home',     'work');     previousView = 'home';     renderFeatured(); };\n            window.goProjects= function() { showView('projects', 'projects'); previousView = 'projects'; };\n            window.goBlog    = function() { showView('blog',     'blog');     previousView = 'blog'; };\n            window.goGallery = function() { showView('gallery',  'gallery');  previousView = 'gallery'; };\n            window.goToContact = function() { showView('contact', 'contact'); };\n\n            window.goBack = function() {\n                if (previousView === 'blog')         goBlog();\n                else if (previousView === 'gallery')  goGallery();\n                else if (previousView === 'projects') goProjects();\n                else goHome();\n            };\n\n            // ---- Featured (public site reads from data-featured attr set at publish time) ----\n            function renderFeatured() {\n                var featuredGrid = document.getElementById('featured-grid');\n                if (!featuredGrid) return;\n                var allCards = Array.from(document.querySelectorAll('#public-grid .project-card'));\n                var featured = allCards.filter(function(c) { return c.dataset.featured === 'true'; });\n                var toShow = featured.length > 0 ? featured : allCards.slice(0, 3);\n                featuredGrid.innerHTML = '';\n                toShow.forEach(function(orig) {\n                    var clone = orig.cloneNode(true);\n                    clone.querySelectorAll('.delete-btn,.star-btn').forEach(function(el){ el.remove(); });\n                    featuredGrid.appendChild(clone);\n                });\n                var pc = document.getElementById('proj-count');\n                if (pc) pc.textContent = toShow.length > 0 ? String(toShow.length).padStart(2,'0') : '‚Äî';\n            }

            window.openItem = function(id) {
                var contentDiv = document.getElementById('detail-content');
                var source     = document.getElementById('data-' + id);
                if (!source) return;
                resetViews();
                views.detail.classList.remove('hidden');
                contentDiv.innerHTML = '';
                source.classList.remove('hidden');
                contentDiv.appendChild(source);
            };

            // ---- Lightbox ----
            window.openLightbox = function(src) {
                document.getElementById('lightbox-img').src = src;
                document.getElementById('lightbox').classList.add('open');
            };
            window.closeLightbox = function() {
                document.getElementById('lightbox').classList.remove('open');
            };
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeLightbox();
            });

            // ---- Sketch lightbox ----
            function attachSketchHandlers() {
                document.querySelectorAll('.sketch-item img').forEach(function(img) {
                    img.onclick = function() { openLightbox(img.src); };
                });
            }

            // ---- Issue date ----
            var dateEl = document.getElementById('issue-date');
            if (dateEl) {
                dateEl.textContent = new Date().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });
            }

            // ---- Counts ----
            function updateCounts() {
                var apc = document.getElementById('all-proj-count');
                var sc  = document.getElementById('sketch-count');
                var bc  = document.getElementById('blog-count');
                var an = document.querySelectorAll('#public-grid .project-card').length;
                var sn = document.querySelectorAll('#sketch-grid .sketch-item').length;
                var bn = document.querySelectorAll('#blog-grid-container .blog-item').length;
                if (apc) apc.textContent = an > 0 ? String(an).padStart(2,'0') : '‚Äî';
                if (sc)  sc.textContent  = sn > 0 ? String(sn).padStart(2,'0') : '‚Äî';
                if (bc)  bc.textContent  = bn > 0 ? String(bn).padStart(2,'0') : '‚Äî';
            }

            // ---- Click delegation for cards ----
            document.addEventListener('click', function(e) {
                var card = e.target.closest('.project-card[data-item-id], .blog-item[data-item-id]');
                if (card) openItem(card.dataset.itemId);
            });

            // ---- Init ----
            attachSketchHandlers();
            updateCounts();
            renderFeatured();
            goHome();
        })();
            `;
        }

        // ============================================
        // SAVE / BACKUP (editor ‚Äî salva o editor completo)
        // ============================================
        function downloadSite() {
            // Now just saves to localStorage ‚Äî no file download needed
            autoSave();
            const btn = document.getElementById('btn-save');
            if (btn) {
                const orig = btn.innerHTML;
                btn.innerHTML = '‚úì Salvo';
                btn.style.background = '#3a8a3a';
                btn.style.borderColor = '#3a8a3a';
                setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; btn.style.borderColor = ''; }, 1800);
            }
        }

        function exportJSON() {
            const data = {
                version: 2,
                exported: new Date().toISOString(),
                publicGrid: document.getElementById('public-grid').innerHTML,
                privateGrid: document.getElementById('private-grid').innerHTML,
                blogGrid: document.getElementById('blog-grid-container').innerHTML,
                artGrid: document.getElementById('art-gallery-container').innerHTML,
                sketchGrid: document.getElementById('sketch-grid').innerHTML,
                hiddenData: Array.from(document.querySelectorAll('body > div[id^="data-"]')).map(el => el.outerHTML).join('')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'portfolio_backup_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function importJSON() {
            document.getElementById('json-input').click();
        }

        document.getElementById('json-input').addEventListener('change', function (e) {
            if (!e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    document.getElementById('public-grid').innerHTML = data.publicGrid || '';
                    document.getElementById('private-grid').innerHTML = data.privateGrid || '';
                    document.getElementById('blog-grid-container').innerHTML = data.blogGrid || '';
                    document.getElementById('art-gallery-container').innerHTML = data.artGrid || '';
                    document.getElementById('sketch-grid').innerHTML = data.sketchGrid || '';

                    // Remove old hidden data
                    document.querySelectorAll('body > div[id^="data-"]').forEach(el => el.remove());

                    // Restore hidden data
                    if (data.hiddenData) {
                        const temp = document.createElement('div');
                        temp.innerHTML = data.hiddenData;
                        Array.from(temp.children).forEach(child => document.body.appendChild(child));
                    }

                    // Re-attach sketch lightbox handlers
                    document.querySelectorAll('.sketch-item img').forEach(img => {
                        img.onclick = () => openLightbox(img.src);
                    });

                    updateCounts();
                    alert("‚úì Dados restaurados com sucesso!");
                } catch (err) {
                    alert("Erro ao importar: " + err.message);
                }
            };
            reader.readAsText(e.target.files[0]);
            this.value = '';
        });

        // ============================================
        // GIST SYNC
        // ============================================

        const GIST_STORAGE_KEY = 'portfolio_gist_config';
        const GIST_FILENAME     = 'portfolio_data.json';

        // --- Helpers ---

        function syncSetStatus(msg, type = 'info') {
            const el = document.getElementById('sync-status');
            el.textContent = msg;
            el.className = 'sync-status visible ' + type;
        }

        function syncSetDot(state) {
            // state: 'synced' | 'pending' | 'error' | ''
            const dot = document.getElementById('sync-dot');
            if (dot) dot.className = 'sync-dot ' + state;
        }

        function setSyncBtnsDisabled(disabled) {
            document.getElementById('btn-push').disabled = disabled;
            document.getElementById('btn-pull').disabled = disabled;
        }

        function formatDate(iso) {
            if (!iso) return '‚Äî';
            return new Date(iso).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        }

        function formatSize(bytes) {
            if (bytes < 1024)       return bytes + ' B';
            if (bytes < 1048576)    return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(2) + ' MB';
        }

        function collectData() {
            const freeBlocks = {};
            ['home-view','projects-view','blog-view','gallery-view','private-view','detail-view','contact-view'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const blocks = Array.from(el.querySelectorAll(':scope > .free-block'));
                if (blocks.length) {
                    freeBlocks[id] = blocks.map(b => ({
                        type:       b.dataset.type,
                        left:       b.style.left,
                        top:        b.style.top,
                        width:      b.style.width,
                        height:     b.style.height,
                        html:       b.querySelector('.fb-content')?.innerHTML || '',
                        fontSize:   b.querySelector('.fb-content')?.style.fontSize || '',
                        fontFamily: b.querySelector('.fb-content')?.style.fontFamily || '',
                        imgSrc:     b.querySelector('img')?.src || ''
                    }));
                }
            });

            return {
                version: 4,
                exported:    new Date().toISOString(),
                publicGrid:  document.getElementById('public-grid').innerHTML,
                privateGrid: document.getElementById('private-grid').innerHTML,
                blogGrid:    document.getElementById('blog-grid-container').innerHTML,
                artGrid:     document.getElementById('art-gallery-container').innerHTML,
                sketchGrid:  document.getElementById('sketch-grid').innerHTML,
                hiddenData:  Array.from(document.querySelectorAll('body > div[id^="data-"]'))
                                  .map(el => el.outerHTML).join(''),
                freeBlocks
            };
        }

        function applyData(data) {
            document.getElementById('public-grid').innerHTML           = data.publicGrid  || '';
            document.getElementById('private-grid').innerHTML          = data.privateGrid || '';
            document.getElementById('blog-grid-container').innerHTML   = data.blogGrid    || '';
            document.getElementById('art-gallery-container').innerHTML = data.artGrid     || '';
            document.getElementById('sketch-grid').innerHTML           = data.sketchGrid  || '';

            document.querySelectorAll('body > div[id^="data-"]').forEach(el => el.remove());
            if (data.hiddenData) {
                const temp = document.createElement('div');
                temp.innerHTML = data.hiddenData;
                Array.from(temp.children).forEach(child => document.body.appendChild(child));
            }

            if (data.freeBlocks) {
                document.querySelectorAll('.free-block').forEach(b => b.remove());
                Object.entries(data.freeBlocks).forEach(([viewId, blocks]) => {
                    const view = document.getElementById(viewId);
                    if (!view) return;
                    blocks.forEach(bd => _restoreFreeBlock(view, bd));
                });
            }

            // Restore sketch lightbox handlers
            document.querySelectorAll('.sketch-item img').forEach(img => {
                img.onclick = () => openLightbox(img.src);
            });

            // Restore star states
            const featured = getFeaturedIds();
            document.querySelectorAll('.star-btn').forEach(btn => {
                const card = btn.closest('.project-card');
                if (card && featured.includes(card.dataset.itemId)) {
                    btn.classList.add('star-on');
                    btn.title = 'Remover destaque';
                }
            });

            renderFeatured();
            updateCounts();
        }

        function _restoreFreeBlock(view, bd) {
            const block = document.createElement('div');
            block.className = 'free-block fb-' + bd.type;
            block.dataset.type = bd.type;
            block.style.left   = bd.left;
            block.style.top    = bd.top;
            block.style.width  = bd.width;
            block.style.height = bd.height;

            const toolbar = document.createElement('div');
            toolbar.className = 'fb-toolbar';
            toolbar.innerHTML = `
                <span class="fb-tool fb-drag-handle" title="Arrastar">‚†ø</span>
                ${bd.type === 'text' ? `
                <span class="fb-tool fb-sep"></span>
                <button class="fb-tool fb-fmt" data-cmd="bold"><b>B</b></button>
                <button class="fb-tool fb-fmt" data-cmd="italic"><i>I</i></button>
                <button class="fb-tool fb-fmt" data-cmd="underline"><u>U</u></button>
                <span class="fb-tool fb-sep"></span>
                <select class="fb-tool fb-size">
                    <option value="0.8rem">XS</option>
                    <option value="1rem">S</option>
                    <option value="1.3rem">M</option>
                    <option value="1.8rem">L</option>
                    <option value="2.6rem">XL</option>
                    <option value="3.6rem">XXL</option>
                </select>
                <select class="fb-tool fb-font">
                    <option value="var(--sans)">Sans</option>
                    <option value="var(--serif)">Serif</option>
                    <option value="var(--mono)">Mono</option>
                </select>
                ` : `
                <span class="fb-tool fb-sep"></span>
                <button class="fb-tool fb-img-upload">üñº Trocar</button>
                `}
                <span class="fb-tool fb-sep"></span>
                <button class="fb-tool fb-del">‚úï</button>`;

            const content = document.createElement('div');
            content.className = 'fb-content';

            if (bd.type === 'text') {
                content.contentEditable = 'true';
                content.innerHTML = bd.html || '';
                if (bd.fontSize)   content.style.fontSize   = bd.fontSize;
                if (bd.fontFamily) content.style.fontFamily = bd.fontFamily;
                content.addEventListener('mousedown', e => e.stopPropagation());
            } else {
                const img = document.createElement('img');
                img.src = bd.imgSrc || 'https://via.placeholder.com/480x300/e8e4db/a09c93';
                img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;';
                content.appendChild(img);
                content.style.height = '100%';
            }

            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'fb-resize';
            resizeHandle.innerHTML = '‚§°';

            block.appendChild(toolbar);
            block.appendChild(content);
            block.appendChild(resizeHandle);

            // Re-attach events
            block.addEventListener('mousedown', function(e) {
                if (e.target.closest('.fb-toolbar') || e.target.closest('.fb-resize')) return;
                deselectAllBlocks();
                block.classList.add('fb-selected');
                _fbSelected = block;
            });

            toolbar.querySelector('.fb-drag-handle').addEventListener('mousedown', function(e) {
                e.preventDefault();
                deselectAllBlocks();
                block.classList.add('fb-selected');
                _fbDragging = block;
                const r = block.getBoundingClientRect();
                _fbOx = e.clientX - r.left;
                _fbOy = e.clientY - r.top;
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'grabbing';
            });

            resizeHandle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                _fbResizing = block;
                _fbOw  = block.offsetWidth;
                _fbOh  = block.offsetHeight;
                _fbOmx = e.clientX;
                _fbOmy = e.clientY;
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'nwse-resize';
            });

            toolbar.querySelector('.fb-del').addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Excluir este bloco?')) block.remove();
            });

            if (bd.type === 'text') {
                toolbar.querySelectorAll('.fb-fmt').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        content.focus();
                        document.execCommand(this.dataset.cmd, false, null);
                    });
                });
                const sizeEl = toolbar.querySelector('.fb-size');
                if (sizeEl) {
                    sizeEl.value = bd.fontSize || '1rem';
                    sizeEl.addEventListener('change', function() { content.style.fontSize = this.value; });
                }
                const fontEl = toolbar.querySelector('.fb-font');
                if (fontEl) {
                    fontEl.value = bd.fontFamily || 'var(--sans)';
                    fontEl.addEventListener('change', function() { content.style.fontFamily = this.value; });
                }
            } else {
                toolbar.querySelector('.fb-img-upload').addEventListener('click', function(e) {
                    e.stopPropagation();
                    currentImg = content.querySelector('img');
                    document.getElementById('file-input').click();
                });
            }

            view.style.position = 'relative';
            view.appendChild(block);
            return block;
        }

        // --- Persistence ---

        function loadSyncConfig() {
            try {
                return JSON.parse(localStorage.getItem(GIST_STORAGE_KEY)) || {};
            } catch { return {}; }
        }

        function saveSyncConfig(cfg) {
            localStorage.setItem(GIST_STORAGE_KEY, JSON.stringify(cfg));
        }

        // --- Modal open/close ---

        function openSyncModal() {
            const cfg = loadSyncConfig();

            // Populate fields
            if (cfg.token)  document.getElementById('gist-token').value = cfg.token;
            if (cfg.gistId) document.getElementById('gist-id').value    = cfg.gistId;

            // Populate info
            document.getElementById('info-last-push').textContent = formatDate(cfg.lastPush);
            document.getElementById('info-last-pull').textContent = formatDate(cfg.lastPull);
            document.getElementById('info-gist-id').textContent   = cfg.gistId
                ? cfg.gistId.slice(0, 8) + '...'
                : '‚Äî';

            // Data size estimate
            const raw = JSON.stringify(collectData());
            document.getElementById('info-data-size').textContent = formatSize(new Blob([raw]).size);

            // Clear status
            document.getElementById('sync-status').className = 'sync-status';

            document.getElementById('sync-modal-backdrop').classList.add('open');
        }

        function closeSyncModal() {
            document.getElementById('sync-modal-backdrop').classList.remove('open');
        }

        // Close on backdrop click
        document.getElementById('sync-modal-backdrop').addEventListener('click', function(e) {
            if (e.target === this) closeSyncModal();
        });

        // --- Push ---

        async function gistPush() {
            const token  = document.getElementById('gist-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim();

            if (!token) {
                syncSetStatus('‚ö† Insira o GitHub Token antes de continuar.', 'err');
                return;
            }

            setSyncBtnsDisabled(true);
            syncSetDot('pending');
            syncSetStatus('Enviando dados‚Ä¶', 'info');

            const payload = JSON.stringify(collectData(), null, 2);

            try {
                let res, json;

                const body = {
                    description: 'Portfolio Lucca Tuelher ‚Äî sync ' + new Date().toISOString(),
                    public: false,
                    files: { [GIST_FILENAME]: { content: payload } }
                };

                if (gistId) {
                    // Update existing Gist (PATCH)
                    res = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify(body)
                    });
                } else {
                    // Create new Gist (POST)
                    res = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify(body)
                    });
                }

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(`GitHub API ${res.status}: ${err.message || res.statusText}`);
                }

                json = await res.json();
                const newId = json.id;

                // Save config
                const now = new Date().toISOString();
                const cfg = loadSyncConfig();
                cfg.token    = token;
                cfg.gistId   = newId;
                cfg.lastPush = now;
                saveSyncConfig(cfg);

                // Update UI
                document.getElementById('gist-id').value              = newId;
                document.getElementById('info-gist-id').textContent   = newId.slice(0, 8) + '...';
                document.getElementById('info-last-push').textContent = formatDate(now);

                syncSetDot('synced');
                syncSetStatus(
                    `‚úì Push conclu√≠do!\nGist ID: ${newId}\nURL: ${json.html_url}`,
                    'ok'
                );

            } catch (err) {
                syncSetDot('error');
                syncSetStatus('‚úï Erro: ' + err.message, 'err');
                console.error('[Gist Push]', err);
            } finally {
                setSyncBtnsDisabled(false);
            }
        }

        // --- Pull ---

        async function gistPull() {
            const token  = document.getElementById('gist-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim();

            if (!token)  { syncSetStatus('‚ö† Insira o GitHub Token.', 'err'); return; }
            if (!gistId) { syncSetStatus('‚ö† Insira o Gist ID para fazer pull.', 'err'); return; }

            setSyncBtnsDisabled(true);
            syncSetDot('pending');
            syncSetStatus('Buscando dados do Gist‚Ä¶', 'info');

            try {
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(`GitHub API ${res.status}: ${err.message || res.statusText}`);
                }

                const gist = await res.json();
                const file = gist.files[GIST_FILENAME];

                if (!file) {
                    throw new Error(`Arquivo "${GIST_FILENAME}" n√£o encontrado no Gist. Verifique o ID.`);
                }

                // Gist may truncate large files ‚Äî fetch raw if needed
                let rawContent = file.content;
                if (file.truncated) {
                    syncSetStatus('Arquivo grande, buscando conte√∫do completo‚Ä¶', 'info');
                    const rawRes = await fetch(file.raw_url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!rawRes.ok) throw new Error('Falha ao buscar raw_url: ' + rawRes.status);
                    rawContent = await rawRes.text();
                }

                const data = JSON.parse(rawContent);

                if (!confirm(`Isso vai substituir todo o conte√∫do atual pelo do Gist.\n√öltima edi√ß√£o: ${data.exported || 'desconhecido'}\n\nContinuar?`)) {
                    syncSetStatus('Pull cancelado.', 'info');
                    setSyncBtnsDisabled(false);
                    syncSetDot('');
                    return;
                }

                applyData(data);

                // Save config
                const now = new Date().toISOString();
                const cfg = loadSyncConfig();
                cfg.token    = token;
                cfg.gistId   = gistId;
                cfg.lastPull = now;
                saveSyncConfig(cfg);

                document.getElementById('info-last-pull').textContent = formatDate(now);

                syncSetDot('synced');
                syncSetStatus(
                    `‚úì Pull conclu√≠do! Dados de ${formatDate(data.exported)} aplicados.`,
                    'ok'
                );

            } catch (err) {
                syncSetDot('error');
                syncSetStatus('‚úï Erro: ' + err.message, 'err');
                console.error('[Gist Pull]', err);
            } finally {
                setSyncBtnsDisabled(false);
            }
        }

        function initSyncDot() {
            const cfg = loadSyncConfig();
            if (cfg.gistId && cfg.lastPush) syncSetDot('synced');
        }

        // ============================================
        // AUTO-SAVE TO LOCALSTORAGE
        // ============================================
        const LS_KEY = 'portfolio_autosave';

        function autoSave() {
            try {
                const data = collectData();

                // Save static editable text (header name, role, contact, etc.)
                data._staticText = {};
                document.querySelectorAll('[data-save-id]').forEach(el => {
                    data._staticText[el.dataset.saveId] = el.innerHTML;
                });

                // Save embed iframes ‚Äî keyed by position index within home-view only
                // (project-level embeds are inside hiddenData)
                data._homeEmbed = document.querySelector('#home-view .edit-embed iframe')?.src || null;

                localStorage.setItem(LS_KEY, JSON.stringify(data));
            } catch(e) { console.warn('AutoSave failed:', e); }
        }

        function autoLoad() {
            try {
                const raw = localStorage.getItem(LS_KEY);
                if (!raw) return false;
                const data = JSON.parse(raw);
                applyData(data);

                // Restore static text
                if (data._staticText) {
                    Object.entries(data._staticText).forEach(([id, html]) => {
                        const el = document.querySelector(`[data-save-id="${id}"]`);
                        if (el) el.innerHTML = html;
                    });
                }

                // Restore home embed
                if (data._homeEmbed) {
                    const homeEmbed = document.querySelector('#home-view .edit-embed');
                    if (homeEmbed) homeEmbed.innerHTML = `<iframe src="${data._homeEmbed}" allowfullscreen></iframe>`;
                }

                return true;
            } catch(e) { console.warn('AutoLoad failed:', e); return false; }
        }

        function startAutoSaveObserver() {
            const targets = ['home-view','projects-view','blog-view','gallery-view','private-view','contact-view'];
            const observer = new MutationObserver(() => {
                clearTimeout(window._autoSaveTimer);
                window._autoSaveTimer = setTimeout(autoSave, 800);
            });
            targets.forEach(id => {
                const el = document.getElementById(id);
                if (el) observer.observe(el, { childList: true, subtree: true, characterData: true });
            });
            observer.observe(document.body, { childList: true });
        }

        // ============================================
        // RUN
        // ============================================
        init();
        initSyncDot();
        autoLoad();
        startAutoSaveObserver();
    </script>
</body>
</html>
